---
title: "Preregistered analysis"
output:
  html_notebook: default
  pdf_document: default
---

TO DO:

* Table of demographics split by gender or anything?
* Reverse code CTQ items
* Choose auxiliary variables for missing data
* Equivalence testing
* Double check the items excluded from PQ-14 are the correct two

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(gt)
library(gtsummary)
library(mice)
library(ggtext)

set.seed(2021)
```

## Analysis parameters

```{r}
# Which outcomes
outcomes <- c("psychotic_pq_sum") 
# Which predictors
predictors <- c("duration_sleep", "efficiency_sleep",
                "subjective_sleep", "social_jetlag")
# Scale of predictors for effect size estimation
scale <- c("cont")
```

## Load in data

```{r}
tidy_df <- read_csv("sim_data.csv")

tidy_df
```

## Demographics table

```{r}
# Convenience fucntion for summing items before imputation
sum_vars <- function(df){
  df %>% 
   mutate(psychotic_pq_sum = pq_1 + pq_2 + pq_3 + pq_4 + pq_5 + pq_6 + pq_7 + pq_8 +
                             pq_9 + pq_10 + pq_11 + pq_12 + pq_13 + pq_14 + pq_15 + pq_16,
          psychotic_pq_14  = pq_2 + pq_3 + pq_4 + pq_5 + pq_6 + pq_8 +
                             pq_9 + pq_10 + pq_11 + pq_12 + pq_13 + pq_14 + pq_15 + pq_16,
          psychotic_ysr_sum   = ysr_1 + ysr_2 + ysr_3,
          psychotic_ysr_dicht = case_when(psychotic_ysr_sum == 0 ~ "None",
                                          psychotic_ysr_sum >= 1 & psychotic_ysr_sum <= 3 ~ "Some",
                                          psychotic_ysr_sum > 3 ~ "Several"),
          ctq_emotional_abuse   = ctq_1 + ctq_2 + ctq_3 + ctq_4 + ctq_5,
          ctq_physical_abuse    = ctq_6 + ctq_7 + ctq_8 + ctq_9 + ctq_10,
          ctq_sexual_abuse      = ctq_11 + ctq_12 + ctq_13 + ctq_14 + ctq_15,
          ctq_emotional_neglect = ctq_16 + ctq_17 + ctq_18 + ctq_19 + ctq_20,
          ctq_physical_neglect  = ctq_21 + ctq_22 + ctq_23 + ctq_24 + ctq_25,
          subjective_sleep = sleep_1 + sleep_2 + sleep_3 + sleep_4 + 
                      sleep_5 + sleep_6 + sleep_7 + sleep_8,
          mom_educt = as.character(mom_educt))
}


tidy_df %>% 
  sum_vars() %>% 
  select(-c(id, psychotic_ysr_sum, pq_1:pq_16, ysr_1:ysr_3,
            sleep_1:sleep_8, ctq_1:ctq_25, psychotic_pq_14)) %>% 
  select(age, sex, ethnicity, mom_educt, mom_depr, psychotic_pq_sum, psychotic_ysr_dicht, everything()) %>% 
  rename_with(~str_replace_all(., "_", " ") %>% 
               ifelse(str_detect(., "sleep"), paste("Sleep" ,str_remove(., "sleep")), .) %>%
               str_to_title %>% 
               ifelse(str_detect(., "Mom Educt"), "Mother's Education", .) %>% 
               ifelse(str_detect(., "Mom Depr"), "Mother's Depression (BSI)", .) %>% 
               ifelse(str_detect(., "Subj"), "Self-reported sleep", .) %>% 
               ifelse(str_detect(., "Pq Sum"), "Psychotic symptoms (PQ)", .) %>%
               ifelse(str_detect(., "Ale"), "Recent Adverse Events", .) %>%
               ifelse(str_detect(., "Ctq"), str_replace(., "Ctq", "CTQ"), .) %>% 
               ifelse(str_detect(., "Dicht"), "Psychotic symptoms (YSR)", .)) %>% 
  mutate(across(where(is.character), ~map_chr(., str_to_sentence)),
         ## Table summary is treating this var as categorical, added miniscule noise to fix
         `Psychotic symptoms (PQ)` = map_dbl(`Psychotic symptoms (PQ)`, ~. + rnorm(1, 0.0001, sd = 0.001))) %>% 
  select(Age:`Social Jetlag`, `Self-reported sleep`, everything()) %>% 
  
  tbl_summary(statistic = list(all_continuous() ~ "{mean} ({sd})"), missing = "no") %>% 
  as_gt() %>% 
  tab_header("Table 1. Demographic characteristics of the sample") %>% 
  opt_table_lines(extent = "none") %>%
  tab_options(
      heading.border.bottom.width = 2,
      heading.border.bottom.style = "solid",
      table.border.top.color = "white",
      table_body.border.top.width = 1,
      heading.title.font.size = 13,
      table.font.size = 12,
      table_body.border.bottom.width = 1,
      table_body.border.bottom.style = "solid",
      column_labels.border.bottom.style = "solid",
      column_labels.border.bottom.width = 1) 
```


## Missing data

### Describe proportions of missing data

```{r fig.height=10, fig.width=5}
tidy_df %>% 
  sum_vars %>% 
  summarise_all(~mean(is.na(.))) %>% 
  pivot_longer(everything()) %>% 
  filter(value != 0) %>% 
  mutate(name = str_replace(name, "_", " ") %>% 
                str_to_upper,
         # name = case_when(str_detect(name, ".+[1-9][1-9]") ~ name,
                          # str_detect(name, ".+[^1-9]") ~ name,
                          # TRUE ~ paste0(name, " ")),
         var_group = str_extract(name, "...")) %>% 
  
  ggplot(aes(x = value,
             y = tidytext::reorder_within(name, value, var_group),
             fill = -value, col = -value)) +
  geom_col(width = 1) +
  geom_text(aes(label = paste0(round(value*100, 1), "%")),
            nudge_x = .015, size = 3) +
  scale_x_continuous(labels = scales::percent) +
  tidytext::scale_y_reordered() +
  labs(x = "Percent missing", y = "Variable",
       title = "Missing data proprotions for each variable") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        plot.title.position = "plot")
```

### Compare non-responedrs to responders

```{r}
non_response_df <-
  tidy_df %>% 
  # Recode into a missing matrix to code if variable is completely missing
  mutate(across(everything(), ~ifelse(is.na(.), 0, 1), .names = "{col}_miss")) %>%
  # Sum up number of missing items per instrument
  rowwise() %>% 
  mutate(sum_pq = sum(c_across(pq_1_miss:pq_16_miss)),
         sum_sleep = sum(c_across(sleep_1_miss:sleep_8_miss)),
         sum_actiwatch = sum(c_across(duration_sleep_miss:social_jetlag_miss))) %>% 
  ungroup() %>% 
  select(-ends_with("miss")) %>% 
  # Dichotomize to either missing or not missing
  mutate(miss_pq = ifelse(sum_pq == 0, "Missing PQ", "Not missing"),
         miss_actiwatch = ifelse(sum_actiwatch == 0, "Missing Actiwatch", "Not missing"),
         miss_subjective_sleep = ifelse(sum_sleep == 0, "Missing Sleep Self-report", "Not missing"),
         miss_all = ifelse(sum_pq == 0 | sum_actiwatch == 0 | sum_sleep == 0,
                           "Some missing", "Complete")) %>% 
  pivot_longer(miss_pq:miss_all, values_to = "which_missing") %>%
  # Filter out categories not of interest
  filter(which_missing != "Not missing",
         which_missing != "Some missing") %>% 
  # Add sum scores for non-response analysis
  sum_vars() %>%  
  # Select variables for non-response analysis
  select(age, sex, ethnicity, mom_educt, mom_depr, psychotic_pq_sum, psychotic_ysr_dicht,
         duration_sleep:social_jetlag, subjective_sleep, recent_ale, matches("ctq_[a-z]"), which_missing) 
  
non_response_df %>% 
  mutate(mom_educt = as.character(mom_educt),
         across(where(is.character), ~map_chr(., str_to_sentence)),
         psychotic_pq_sum = map_dbl(psychotic_pq_sum, ~. + rnorm(1, 0.0001, sd = 0.001)),
         which_missing = str_replace(which_missing, "pq", "PQ") %>% 
                         str_replace("actiwatch", "Actiwatch") %>% 
                         str_replace("sleep self", "Sleep Self")) %>% 
  rename_with(~str_replace(., "_", " ") %>% 
               ifelse(str_detect(., "sleep"), paste("Sleep" ,str_remove(., "sleep")), .) %>%
               str_to_title %>% 
               ifelse(str_detect(., "Mom Educt"), "Mother's Education", .) %>% 
               ifelse(str_detect(., "Mom Depr"), "Mother's Depression (BSI)", .) %>% 
               ifelse(str_detect(., "Subj"), "Self-reported sleep", .) %>% 
               ifelse(str_detect(., "Ale"), "Recent Adverse Events", .) %>%
               ifelse(str_detect(., "Ctq"), str_replace(., "Ctq", "CTQ"), .) %>% 
               ifelse(str_detect(., "Pq_sum"), "Psychotic symptoms (PQ)", .) %>% 
               ifelse(str_detect(., "dicht"), "Psychotic symptoms (YSR)", .)) %>% 
  
  tbl_summary(by = "Which Missing", missing_text = "-") %>% 
  add_p() %>% 
  as_gt() %>% 
  tab_header("Appendix Table 1. Non-response patterns among predictor and outcome variables") %>% 
  opt_table_lines(extent = "none") %>%
  tab_options(
      heading.border.bottom.width = 2,
      heading.border.bottom.style = "solid",
      table.border.top.color = "white",
      table_body.border.top.width = 1,
      heading.title.font.size = 13,
      table.font.size = 12,
      table_body.border.bottom.width = 1,
      table_body.border.bottom.style = "solid",
      column_labels.border.bottom.style = "solid",
      column_labels.border.bottom.width = 1) 

```
### Impute missing data

```{r}
# Preparing the multiple imputation --------------------------------------------

# Generate MICE object to specify parameters
mice_initial <- mice(tidy_df, m = 1, printFlag = F)

# Variables that will not be used as predictors 
mice_initial$predictorMatrix["id", ] <- 0

pred_matrix <- mice_initial$predictorMatrix  
# Performing the multiple imputation -------------------------------------------

# Number of imputations which will be determined on the basis of how much data is missing
n_imp <- 5

# Impute and convert to long format for post-processing
mice_obj <- mice(tidy_df, m = n_imp, predictorMatrix = pred_matrix, printFlag = F)
mice_long <- complete(mice_obj, action = "long", include = T)

```
### Check trace plot diagnostics:

```{r}
plot(mice_obj)
```

## Data transformations and distributions

### Transformations

```{r}
imputed_df <-
  mice_long %>% 
  mutate(subjective_sleep = sleep_1 + sleep_2 + sleep_3 + sleep_4 + 
                      sleep_5 + sleep_6 + sleep_7 + sleep_8,
         # subjective_sleep_sqrt = sqrt(subjective_sleep + 0.000001),
         ctq_emotional_abuse   = ctq_1 + ctq_2 + ctq_3 + ctq_4 + ctq_5,
         ctq_physical_abuse    = ctq_6 + ctq_7 + ctq_8 + ctq_9 + ctq_10,
         ctq_sexual_abuse      = ctq_11 + ctq_12 + ctq_13 + ctq_14 + ctq_15,
         ctq_emotional_neglect = ctq_16 + ctq_17 + ctq_18 + ctq_19 + ctq_20,
         ctq_physical_neglect  = ctq_21 + ctq_22 + ctq_23 + ctq_24 + ctq_25,
         psychotic_pq_sum = pq_1 + pq_2 + pq_3 + pq_4 + pq_5 + pq_6 + pq_7 + pq_8 +
                  pq_9 + pq_10 + pq_11 + pq_12 + pq_13 + pq_14 + pq_15 + pq_16,
         psychotic_pq_14  = pq_2 + pq_3 + pq_4 + pq_5 + pq_6 + pq_8 +
                             pq_9 + pq_10 + pq_11 + pq_12 + pq_13 + pq_14 + pq_15 + pq_16) %>% 
         # psychotic_ysr_sum = ysr_1 + ysr_2 + ysr_3,
         # psychotic_ysr_dicht = case_when(psychotic_ysr_sum == 0 ~ "none",
                               # psychotic_ysr_sum >= 1 & psychotic_ysr_sum <= 3 ~ "some",
                               # psychotic_ysr_sum > 3 ~ "several")) %>% 
  
  as.mids()
```

### Check distributions

```{r}

dist_df <-
  imputed_df %>% 
  complete(action = "long", include = F) %>% 
  select(-ethnicity) %>% 
  pivot_longer(duration_sleep:psychotic_pq_sum) %>% 
  group_by(name) %>% 
  mutate(name = str_replace_all(name, "_", " ") %>% 
                str_to_title,
         median = median(value),
         mean = mean(value),
         var_str   = str_extract(name, "..."),
         var_group = ifelse(str_detect(var_str,"Pq") |
                            var_str == "Ysr" |
                            var_str == "Sle",
                            "item", "subscale")) %>% 
  ungroup()

# To plot subscale distributions before item distributions
item_names <-
  dist_df %>% 
  filter(var_group == "subscale") %>% 
  distinct(name) %>% 
  pull()

dist_df %>%
  mutate(name = fct_relevel(name, item_names)) %>%
  
  ggplot(aes(x = value)) +
  geom_histogram(fill = "#37718E") +
  labs(x = "", y = "",
       title = "Distributions of all modelled variables") +
  facet_wrap(~name, scales = "free") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        title = element_text(size = 9),
        strip.text = element_text(size = 6))
  
```
## Outliers

### Boxplot

```{r}

is_outlier <- function(x) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x))
}


imputed_df %>% 
  complete(action = "long", include = F) %>% 
  select(-ethnicity) %>% 
  pivot_longer(all_of(outcomes)) %>% 
  mutate(name = str_replace_all(name, "_", " ") %>% 
                str_to_upper) %>% 
  group_by(name) %>% 
  mutate(outlier = ifelse(is_outlier(value), value, NA)) %>% 
  
  ggplot(aes(x = name, y = value)) +
  geom_boxplot(col = "#37718E", ) + 
  geom_text(aes(label = round(outlier, 1)), nudge_x = .15, na.rm = T,
            size = 2, color = "#37718E") +
  theme_bw() +
  labs(x = "", y = "",
       title = "Outliers in the outcome variable(s)") +
  theme(legend.position = "none")

```

### Detecting outliers

```{r}

# Function to detect outliers based on a prespecified quantile (here 2.5%)
quantile_outliers <- function(var, quant = 2.5){

low_bound <- quant*0.01
upp_bound <- (100-quant)*0.01  

low_quant <- quantile(var, low_bound)
up_quant  <- quantile(var, upp_bound)

which(var < low_quant | var > up_quant) %>% 
  as_tibble() %>% 
  nest(data = everything())
}

# Extract the IDs of where the outliers occur
outliers_id <-
  imputed_df %>% 
  complete(action = "long", include = F) %>% 
  summarise(across(all_of(outcomes), quantile_outliers))

# Flag rows that have the outlier
outliers_df <-
  imputed_df %>% 
  complete(action = "long", include = T) %>% 
  mutate(id_out = 1:n(),
         psychotic_pq_sum_outlier = if_else(id_out %in% pull(unnest(outliers_id$psychotic_pq_sum)), 1, 0)) %>% 
         # subjective_sleep_outlier = if_else(id_out %in% pull(unnest(outliers_id$subjective_sleep)), 1, 0),
         # duration_sleep_outlier = if_else(id_out %in% pull(unnest(outliers_id$duration_sleep)), 1, 0),
         # efficiency_sleep_outlier = if_else(id_out %in% pull(unnest(outliers_id$efficiency_sleep)), 1, 0),
         # arousal_sleep_outlier = if_else(id_out %in% pull(unnest(outliers_id$arousal_sleep)), 1, 0),
         # social_jetlag_outlier = if_else(id_out %in% pull(unnest(outliers_id$social_jetlag)), 1, 0),
         # outlier_any = if_else((subjective_sleep_outlier + duration_sleep_outlier +
                                # efficiency_sleep_outlier + social_jetlag_outlier) >= 1, 1, 0)) %>% 
  # Make sure that if outlier is flagged in one imputatiot, it is identified as such in all others
  group_by(id) %>% 
  mutate(across(ends_with("outlier"), max))

```

## Analysis

### Define function for analysis

Takes as input:

* The main predictor in the model to be fitted
* The outcome of the model
* Whether the main predictor is continous or categorical

It then runs the linear model on the imputed datasets, pools the parameters, 
and calculates either Cohen's d or Pearson's r (partial correlation)

Returns as output:

* A mira linear fit object
* A tibble with coefficients and effect sizes

```{r}
### TEST FOR FUNCTION ####
outcome   <- "psychotic_pq_sum"
predictor <- "social_jetlag"
predictor_scale <- "cont"
remove_outlier <- TRUE

if(remove_outlier == TRUE){

outlier_var <- paste0(outcome, "_outlier")

mod  <- lm.mids(paste(outcome, "~", predictor,
                      # Covariates to include
                      "+ age + sex + ethnicity + 
                      ctq_emotional_abuse + ctq_sexual_abuse +
                      ctq_physical_abuse + recent_ale"),
                # Remove outliers of outcome variable
                data = as.mids(outliers_df %>% 
                               filter(!!as.symbol(outlier_var) == 0)))
    

} else if(remove_outlier == FALSE){
  mod  <- lm.mids(paste(outcome, "~", predictor,
                      # Covariates to include
                      "+ age + sex + ethnicity + 
                      ctq_emotional_abuse + ctq_sexual_abuse +
                      ctq_physical_abuse + recent_ale"),
                data = imputed_df)
} else NA


# Extract parameters from the model
par  <- 
  parameters::model_parameters(mod) %>% 
  as_tibble() %>% 
  janitor::clean_names()

 # Calculate effect size and confidence interval of the main predictor
# Cohen's d for categorical, Pearson's r for continuous

if(predictor_scale == "cont"){

eff_size <-
  effectsize::t_to_r(par[par$parameter == predictor, "statistic"],
                     df_error = par[par$parameter == predictor, "df_error"]) %>%
  as_tibble() %>%
  unnest(c(CI_low, CI_high)) %>%
  select(eff_size = statistic,
         eff_ci_low = CI_low,
         eff_ci_high = CI_high) %>% 
  mutate(parameter = predictor)

}else if(predictor_scale == "categ"){
eff_size <-
   par %>% 
   filter(str_detect(parameter, predictor)) %>% 
   transmute(parameter,
             eff = map2(statistic, df_error,
                        ~effectsize::t_to_d(.x, df_error = .y) %>% 
                         as_tibble() %>% 
                         unnest(c(CI_low, CI_high)))) %>% 
   unnest(eff) %>%
   select(parameter,
          eff_size = d,
          eff_ci_low = CI_low,
          eff_ci_high = CI_high)
  
}else NA

coeff_results <-
  par %>% 
  filter(parameter != "(Intercept)") %>% 
  select(parameter, coefficient, ci_low, ci_high, p) %>% 
  left_join(eff_size, by = "parameter")

tibble(model = list(mod), 
       coeff_results = list(coeff_results))
```


```{r}

run_model <- function(outcome, predictor, predictor_scale = "cont",
                      remove_outlier = FALSE){
  
# Fit model depending on whether outliers are to be removed or not  
    
if(remove_outlier == TRUE){

outlier_var <- paste0(outcome, "_outlier")

mod  <- lm.mids(paste(outcome, "~", predictor,
                      # Covariates to include
                      "+ age + sex + ethnicity + 
                      ctq_emotional_abuse + ctq_sexual_abuse +
                      ctq_physical_abuse + recent_ale"),
                # Remove outliers of outcome variable
                data = as.mids(outliers_df %>% 
                               filter(!!as.symbol(outlier_var) == 0)))
    

} else if(remove_outlier == FALSE){
  mod  <- lm.mids(paste(outcome, "~", predictor,
                      # Covariates to include
                      "+ age + sex + ethnicity + 
                      ctq_emotional_abuse + ctq_sexual_abuse +
                      ctq_physical_abuse + recent_ale"),
                data = imputed_df)
} else NA

# Extract parameters from the model

par  <- 
  parameters::model_parameters(mod) %>% 
  as_tibble() %>% 
  janitor::clean_names()

# Calculate effect size and confidence interval of the main predictor
# Cohen's d for categorical, Pearson's r for continuous

if(predictor_scale == "cont"){

eff_size <-
  effectsize::t_to_r(par[par$parameter == predictor, "statistic"],
                     df_error = par[par$parameter == predictor, "df_error"]) %>%
  as_tibble() %>%
  unnest(c(CI_low, CI_high)) %>%
  select(eff_size = statistic,
         eff_ci_low = CI_low,
         eff_ci_high = CI_high) %>% 
  mutate(parameter = predictor)

}else if(predictor_scale == "categ"){
eff_size <-
   par %>% 
   filter(str_detect(parameter, predictor)) %>% 
   transmute(parameter,
             eff = map2(statistic, df_error,
                        ~effectsize::t_to_d(.x, df_error = .y) %>% 
                         as_tibble() %>% 
                         unnest(c(CI_low, CI_high)))) %>% 
   unnest(eff) %>%
   select(parameter,
          eff_size = d,
          eff_ci_low = CI_low,
          eff_ci_high = CI_high)
  
}else NA

coeff_results <-
  par %>% 
  filter(parameter != "(Intercept)") %>% 
  select(parameter, coefficient, ci_low, ci_high, p) %>% 
  left_join(eff_size, by = "parameter")

tibble(model = list(mod), 
       coeff_results = list(coeff_results))
}
```

### Run the analysis for each predictor and outcome

```{r}
model_coefs_df <-
  tibble(predictor = predictors,
         scale = scale) %>% 
  expand(nesting(predictor, scale), 
         outcome = outcomes) %>% 
  mutate(result = pmap(list(outcome, predictor, scale), run_model)) %>% 
  select(-scale) %>% 
  unnest(result)

```

## Diagnostics

```{r}

extract_pred_resids <- function(model, outc, pred){

 RS1=NULL
 PS1=NULL

  for(i in n_imp){
  RS1=rbind(RS1,residuals(model$analyses[[i]]))
  RS=colMeans(RS1)
  PS1=rbind(PS1,predict(model$analyses[[i]])) 
  PS=colMeans(PS1)}
 
 tibble(res = RS, predict = PS, outcome = outc, predictor = pred)
}

model_coefs_df %>% 
  select(-coeff_results) %>% 
  transmute(diag = pmap(list(model, outcome, predictor),
                        extract_pred_resids)) %>% 
  unnest(diag) %>%
  mutate(across(c(outcome, predictor), ~str_replace_all(., "_", " ") %>% 
                                        str_to_upper())) %>% 
         # predictor = if_else(str_detect(predictor, "dicht"), "YSR pred", "PQ pred"),
         # outcome = str_replace_(outcome, "_", " ") %>% 
                   # str_to_title) %>% 

  ggplot(aes(x = res, y = predict)) +
  geom_point(alpha = .7, shape = 16, color = "#37718E") +
  geom_smooth(color = "black", method = "lm") +
  facet_grid(predictor~outcome, scales = "free") +
  labs(x = "Residual value", y = "Predicted value",
       title = "Residual distributions of reggresion models",
       subtitle = "Split by outcomes along the top and predictors along the right") +
  theme_bw() +
  theme(legend.position = "none",
        strip.text = element_text(size = 6),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 9)
        )
  
```

## Results

Convenience function to show rounded results with trailing zeroes

```{r}
round_trail <- function(string) sprintf("%.2f", round(string, 2))

combine_ci <- function(lower, upper){
  paste0("[", round_trail(lower), ", ",
         round_trail(upper), "]")
}

```

### Adjust p-values using Holm method

```{r}
adjusted_coeffs <-
  model_coefs_df %>% 
  select(-model) %>% 
  unnest(coeff_results) %>% 
  group_by(parameter, predictor) %>% 
  nest() %>% 
  mutate(data = map(data, 
                    ~mutate(.,
                            p_adj = p.adjust(p, method = "holm"),
                            .after = p))) %>% 
  unnest(data) %>% 
  ungroup()

```

### R squared

```{r}
rsqr_df <-
  model_coefs_df %>% 
  transmute(predictor, outcome,
            r_sqr = map(model, ~as_tibble(pool.r.squared(.)))) %>% 
  unnest(r_sqr) %>% 
  select(predictor, outcome, rsqr = est,
         rsqr_low = `lo 95`,
         rsqr_upp = `hi 95`)

rsqr_df %>% 
  mutate_if(is.numeric, round_trail)
```

### Coefficient plot

```{r}

coefs_df <-
  adjusted_coeffs %>%  
  left_join(rsqr_df, by = c("predictor", "outcome")) %>% 
  filter(str_detect(parameter, "sleep|jetlag")) %>% 
  mutate(across(c(outcome, parameter), ~str_replace_all(., "_", " ") %>%  
                                        str_to_upper),
         # analysis =  if_else(str_detect(parameter, "sum"), "Continous", "Dichotomous"),
         # parameter = case_when(str_detect(parameter, "sum") ~ "Psychotic Experience\n(continuous sum total)",
                               # str_detect(parameter, "some") ~ "YSR Psychotic Experience\n(Some symptoms vs. None)",
                               # str_detect(parameter, "several") ~ "YSR Psychotic Experience\n(Several symptoms vs. None)"),
         ci = paste0("[", round_trail(ci_low), ", ", round_trail(ci_high), "]"),
         rsqr_ci = paste0(round_trail(rsqr), " [",
                          round_trail(rsqr_low), ", ", round_trail(rsqr_upp), "]"))

coeff_plot <-
  coefs_df %>%   
  ggplot(aes(x = coefficient, y = parameter, col = outcome)) +
  geom_point(shape = 1) +
  geom_errorbarh(aes(xmin = ci_low, xmax = ci_high), height = 1/4) +
  geom_text(aes(label = round_trail(coefficient)),
            nudge_y = .35, size = 2) +
  geom_text(aes(label = ci),
            nudge_y = -.3, size = 2) +
  geom_richtext(aes(label = paste0("R<sup>2</sup> = " ,rsqr_ci),
                    x = max(ci_high) + 0.06),
                color = "black", label.color = NA, fill = NA,
                data = distinct(coefs_df, rsqr_ci, parameter, outcome, .keep_all = T),
                size = 2.5) +
  # facet_wrap(~outcome, ncol = 1) +
  scale_color_manual(values = c("#37718E", "#7c7e7f")) +
  expand_limits(x = max(coefs_df$ci_high) + 0.1) +
  labs(x = "Coefficient estimate", y = "",
       title = "Main predictor coefficients from every predictor on PQ-16 score") +
  coord_cartesian(clip = "off") +
  theme_minimal() +
  theme(legend.position = "none", 
        aspect.ratio = .25,
        panel.grid = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 7),
        strip.text = element_text(size = 7),
        title = element_text(size = 10))

coeff_plot
ggsave("plots/coeff_plot.png", plot = coeff_plot, scale = 2, bg = "white")
```

### Full coefficient table

```{r}
adjusted_coeffs %>% 
  transmute(# model = case_when(str_detect(predictor, "pq") ~ "PQ Psychotic Experience)",
                               # str_detect(predictor, "ysr") ~ "YSR Psychotic Experience"),
            # outcome = str_replace_all(outcome, "_", " ") %>% 
                   # str_to_upper %>% 
                   # if_else(. == "Subj Sleep", "Subjective Sleep", .),
            predictor = str_replace_all(predictor, "_", " ") %>%  
                                        str_to_upper(),
            parameter = case_when(str_detect(parameter, "sum") ~ "PQ Psychotic Experience",
                               # str_detect(parameter, "some") ~ "YSR Psychotic Experience\n(Some symptoms)",
                               # str_detect(parameter, "several") ~ "YSR Psychotic Experience\n(Several symptoms)",
                               str_detect(parameter, "mom_depr") ~ "Mother's Depression (BSI)",
                               str_detect(parameter, "mom_educthigh") ~ "Mother's Education (High School)",
                               str_detect(parameter, "mom_eductno") ~ "Mother's Education (No Education)",
                               str_detect(parameter, "non-western") ~ "Ethnicity (Non-Western)",
                               str_detect(parameter, "other") ~ "Ethnicity (Other-Western)",
                               str_detect(parameter, "ale") ~ "Recent adverse events",
                               str_detect(parameter, "sex$") ~ "Sex",
                               str_detect(parameter, "ctq") ~ str_replace(parameter, "ctq", "CTQ") %>%
                                                              str_replace_all("_", " "),
                               str_detect(parameter, "age") ~ "Age",
                               TRUE ~ str_replace_all(parameter, "_", " ") %>%  
                                      str_to_title()
                               ),
            coefficient = round_trail(coefficient),
            ci = combine_ci(ci_low, ci_high),
            p = round(p_adj, 3)) %>% 
  
  
  gt(groupname_col = "predictor") %>% 
  cols_label(parameter = "Coefficient",
             coefficient = "Estimate",
             ci = "95% CI",
             p = "p-value") %>%
  tab_header("Appendix Table 2. Coefficient estimates for all parameters in the models") %>% 
  tab_footnote("Reference category for Mother's Education = Higher Education",
               location = cells_body(columns = parameter,
                                     rows = str_detect(parameter, "Education"))) %>% 
  tab_footnote("Reference category for Ethnicity = Western",
               location = cells_body(columns = parameter,
                                     rows = str_detect(parameter, "Ethnicity"))) %>% 
  tab_footnote("Reference category for YSR Psychotic Experiences = No symptoms",
               location = cells_body(columns = parameter,
                                     rows = str_detect(parameter, "YSR"))) %>% 
  opt_table_lines(extent = "none") %>%
  tab_options(
      row_group.font.weight = "bold",
      heading.border.bottom.width = 2,
      heading.border.bottom.style = "solid",
      table.border.top.color = "white",
      table_body.border.top.width = 1,
      heading.title.font.size = 13,
      table.font.size = 12,
      table_body.border.bottom.width = 1,
      table_body.border.bottom.style = "solid",
      column_labels.border.bottom.style = "solid",
      column_labels.border.bottom.width = 1) 
```


### Main effects table

```{r}
tbl_main_effects <-
  # Format numbers for table
  coefs_df %>% 
  transmute(predictor = str_replace_all(predictor, "_", " ") %>% 
                        str_to_title(.), 
            coeff     = round_trail(coefficient),
            coeff_ci  = combine_ci(ci_low, ci_high),
            p_adj     = sprintf("%.3f", round(p, 3)),
            eff_size  = round_trail(eff_size),
            eff_ci    = combine_ci(eff_ci_low, eff_ci_high),
            rsqr      = round_trail(rsqr),
            rsqr_ci   = combine_ci(rsqr_low, rsqr_upp)) %>% 
  # Construct table
  gt(rowname_col = "predictor") %>% 
  cols_label(coeff    = paste("Unstadardized", greekLetters::greeks("beta")),
             coeff_ci = "95% CI",
             p_adj    = "p-value",
             eff_size = "Pearson's r",
             eff_ci   = "95% CI",
             rsqr     = html("R<sup>2</sup>"),
             rsqr_ci  = "95% CI") %>% 
  tab_header(title = html("Table 2. Coefficient estimates and effect sizes of sleep predictors for psychotic experiences outcome and model fit (R<sup>2</sup>) for each full model")) %>% 
  tab_footnote("All estimates adjusted for sex, age, ethnicity, mother's education and mother's depression",
               location = cells_column_labels(coeff)) %>% 
  tab_footnote("Displayed p-values are adjusted via Holm's method", 
               locations = cells_column_labels(p_adj)) %>% 
  tab_footnote("Effect sizes calculated using partial r adjusted for confounders", 
               locations = cells_column_labels(eff_size)) %>% 
  opt_table_lines(extent = "none") %>%
  tab_options(
      heading.border.bottom.width = 2,
      heading.border.bottom.style = "solid",
      table.border.top.color = "white",
      table_body.border.top.width = 1,
      heading.title.font.size = 13,
      table.font.size = 12,
      table_body.border.bottom.width = 1,
      table_body.border.bottom.style = "solid",
      column_labels.border.bottom.style = "solid",
      column_labels.border.bottom.width = 1) 

tbl_main_effects  
```

## Sensitivity analyses

### Remove outliers

```{r}

# Refit model this time removing outliers for each outcome
noOutliers_df <-
  tibble(predictor = c("subjective_sleep", "duration_sleep", 
                       "efficiency_sleep","social_jetlag"),
         scale = c("cont")) %>% 
  expand(nesting(predictor, scale), 
         outcome = c("psychotic_pq_sum")) %>% 
  mutate(result = pmap(list(outcome, predictor, scale), ~run_model(..1, ..2, ..3,
                                                                   remove_outlier = T))) %>% 
  select(-scale) %>% 
  unnest(result)

# Coeff plot
noOutliers_plot <-
  noOutliers_df %>% 
  select(-model) %>% 
  unnest(coeff_results) %>% 
  filter(str_detect(parameter, "sleep|jetlag")) %>% 
  mutate(across(c(outcome, parameter), ~str_replace_all(., "_", " ") %>%  
                                        str_to_upper),
         analysis = "Drop outliers") %>%
  
  ggplot(aes(x = coefficient, y = parameter, col = analysis)) +
  geom_point(shape = 1) +
  geom_errorbarh(aes(xmin = ci_low, xmax = ci_high), linetype = 2) +
  geom_text(aes(label = round_trail(coefficient)),
            nudge_y = .4, size = 2, show.legend = F) +
  facet_wrap(~analysis, scales = "free", ncol = 1) +
  scale_color_manual(values = c("#4a5759")) +
  labs(x = "Coefficient estimate", y = "", col = "", linetype = "") +
  theme_minimal() +
  theme(legend.position = "none", 
        aspect.ratio = .25,
        panel.grid = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 7),
        strip.text = element_text(size = 7),
        title = element_text(size = 10))

# Effect size table
noOutlers_coeff_tbl <-
  noOutliers_df %>% 
  select(-model) %>% 
  unnest(coeff_results) %>% 
  filter(str_detect(parameter, "sleep|jetlag")) %>% 
  transmute(predictor = str_replace_all(predictor, "_", " ") %>% 
                        str_to_title(.), 
            coeff     = round_trail(coefficient),
            coeff_ci  = combine_ci(ci_low, ci_high),
            p_adj     = sprintf("%.3f", round(p, 3)),
            eff_size  = round_trail(eff_size),
            eff_ci    = combine_ci(eff_ci_low, eff_ci_high))
```

### Use PQ with 14 items (no affective problems)

```{r}
# Refit model with the 14 item PQ sum score as outcome
pq14_df <-
  tibble(predictor = c("subjective_sleep", "duration_sleep", 
                       "efficiency_sleep","social_jetlag"),
         scale = c("cont")) %>% 
  expand(nesting(predictor, scale), 
         outcome = c("psychotic_pq_14")) %>% 
  mutate(result = pmap(list(outcome, predictor, scale), run_model)) %>% 
  select(-scale) %>% 
  unnest(result)

# Plot coefficients
pq14_plot <-  
  pq14_df %>% 
  select(-model) %>% 
  unnest(coeff_results) %>% 
  filter(str_detect(parameter, "sleep|jetlag")) %>% 
  mutate(across(c(outcome, parameter), ~str_replace_all(., "_", " ") %>%  
                                        str_to_upper),
         analysis = "Drop 2 affective items from PQ-16") %>%
  
  ggplot(aes(x = coefficient, y = parameter, col = analysis)) +
  geom_point(shape = 1) +
  geom_errorbarh(aes(xmin = ci_low, xmax = ci_high), linetype = 2) +
  geom_text(aes(label = round_trail(coefficient)),
            nudge_y = .4, size = 2, show.legend = F) +
  facet_wrap(~analysis, scales = "free", ncol = 1) +
  scale_color_manual(values = c("#297373")) +
  labs(x = "Coefficient estimate", y = "", col = "", linetype = "") +
  theme_minimal() +
  theme(legend.position = "none", 
        aspect.ratio = .25,
        panel.grid = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 7),
        strip.text = element_text(size = 7),
        title = element_text(size = 10))

# Main coefficients table
pq14_coeff_tbl <-
  pq14_df %>% 
  select(-model) %>% 
  unnest(coeff_results) %>% 
  filter(str_detect(parameter, "sleep|jetlag")) %>% 
  transmute(predictor = str_replace_all(predictor, "_", " ") %>% 
                        str_to_title(.), 
            coeff     = round_trail(coefficient),
            coeff_ci  = combine_ci(ci_low, ci_high),
            p_adj     = sprintf("%.3f", round(p, 3)),
            eff_size  = round_trail(eff_size),
            eff_ci    = combine_ci(eff_ci_low, eff_ci_high))
```

### Plot results from sensitivity analyses together with main results

```{r}
library(patchwork)

# Get rid of R2 layer
coeff_plot_main <- coeff_plot
coeff_plot_main$layers[[5]] <- NULL

# Plot alltogether
(coeff_plot_main + 
    facet_wrap(~"Complete analysis") + 
    labs(x = "", title = "Coefficients from main and sensitivity analyses"))/
 (noOutliers_plot + labs(x = ""))/
  pq14_plot  
```

### Coefficient estimates from all analysis together

```{r}

bind_rows(
  tbl_main_effects$`_data` %>% select(-contains("rsqr")) %>% mutate(analysis = "Complete analysis"),         
  noOutlers_coeff_tbl %>% mutate(analysis = "Drop outliers"),
  pq14_coeff_tbl %>% mutate(analysis = "Drop 2 affective items from PQ-16"),
) %>% 
  gt(groupname_col = "analysis") %>% 
  cols_label(coeff    = paste("Unstadardized", greekLetters::greeks("beta")),
             coeff_ci = "95% CI",
             p_adj    = "p-value",
             eff_size = "Pearson's r",
             eff_ci   = "95% CI") %>% 
  tab_header(title = html("Appendix Table 3. Coefficient estimates and effect sizes from all sensitivity analysis compared to the complete main analysis")) %>% 
  tab_footnote("All estimates adjusted for sex, age, ethnicity, mother's education and mother's depression",
               location = cells_column_labels(coeff)) %>% 
  tab_footnote("Displayed p-values are adjusted via Holm's method", 
               locations = cells_column_labels(p_adj)) %>% 
  tab_footnote("Effect sizes calculated using partial r adjusted for confounders", 
               locations = cells_column_labels(eff_size)) %>% 
  opt_table_lines(extent = "none") %>%
  tab_options(
      row_group.font.weight = "bold",
      heading.border.bottom.width = 2,
      heading.border.bottom.style = "solid",
      table.border.top.color = "white",
      table_body.border.top.width = 1,
      heading.title.font.size = 13,
      table.font.size = 12,
      table_body.border.bottom.width = 1,
      table_body.border.bottom.style = "solid",
      column_labels.border.bottom.style = "solid",
      column_labels.border.bottom.width = 1) 
```

# Exploratory interaction analyses

### Convenience functions

For plotting interaction effects

```{r}
# Cut into mean plus minus a standard deviation
mean_sd_cat <- function(vector){

mean     <- mean(vector, na.rm = T)
plus_sd  <- mean + sd(vector, na.rm = T)
minus_sd <- mean - sd(vector, na.rm = T)

c(mean, plus_sd, minus_sd)
}

# Use the +- 1SD range of a vector
min_to_max <- function(vector, length = 5){
  seq(from = mean(vector, na.rm = T) - sd(vector, na.rm = T),
      to   = mean(vector, na.rm = T) + sd(vector, na.rm = T),
      length.out = length)
}

format_lab <- function(string){
  str_replace_all(string, "_", " ") %>% 
  str_to_title() %>% 
  str_replace_all("Ctq", "CTQ") 
}
```


```{r}
predictor <- "social_jetlag"
interaction <- "ctq_physical_abuse"

fit_interaction_model <- function(predictor, interaction){

# Fit interaction model
interaction_fit <-
  lm.mids(paste("psychotic_pq_sum ~", predictor, "*", interaction,
                "+ age + sex + ethnicity + recent_ale"),
          data = imputed_df)

# Extract coefficients
coeff_df <-
  parameters::parameters(interaction_fit) %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  filter(parameter != "(Intercept)") %>% 
  select(parameter, coefficient, ci_low, ci_high, p)

# Get values for predictor (mean ± 1SD)
predictor_levels <-
  imputed_df %>% 
  complete() %>% 
  pull(predictor) %>% 
  mean_sd_cat()

# Get values for interaction (10 values ranging from -1SD to +1SD)
interaction_range <-
  imputed_df %>% 
  complete() %>% 
  pull(predictor) %>%
  ggeffects::pretty_range(n = 2)

# Store values in list
interaction_values <- list(predictor_levels, interaction_range)
names(interaction_values) <- c(predictor, interaction)

# Plot
plot <-
  emmeans::emmip(interaction_fit, as.formula(paste(predictor,"~" ,interaction)),
      at = interaction_values, CIs = T) +
  theme_minimal() +
  scale_x_continuous(breaks = interaction_range) +
  scale_y_continuous() +
  scale_color_manual(values = c("#37718E", "#FF6542", "#5FAD56"),
                     labels = ~round_trail(as.numeric(.))) +
  labs(x = format_lab(interaction), y = "",
       color = paste(format_lab(predictor))) +
  theme(legend.position = "top",
        aspect.ratio = 1)

result <-
  tibble(coeffs = list(coeff_df),
         plot   = list(plot))

return(result)
}
```

### Fit models

```{r}
interaction_fits <-
  tibble(interaction = c("ctq_emotional_abuse", "ctq_physical_abuse", "ctq_sexual_abuse")) %>% 
  expand(nesting(interaction), predictors) %>% 
  mutate(result = map2(predictors, interaction, ~fit_interaction_model(predictor = .x,
                                                                       interaction = .y))) %>% 
  unnest(result) %>% 
  arrange(predictors)
```

### Assemble interaction plot

```{r fig.height=10, fig.width=7}
duration_plot <-
  (interaction_fits$plot[[1]] + theme(legend.position = "none")) +
   interaction_fits$plot[[2]] +
  (interaction_fits$plot[[3]] + theme(legend.position = "none"))

efficiency_plot <-
  (interaction_fits$plot[[4]] + theme(legend.position = "none")) +
   interaction_fits$plot[[5]] +
  (interaction_fits$plot[[6]] + theme(legend.position = "none"))

jetlag_plot <-
  (interaction_fits$plot[[7]] + theme(legend.position = "none")) +
   interaction_fits$plot[[8]] +
  (interaction_fits$plot[[9]] + theme(legend.position = "none"))

subjective_plot <-
  (interaction_fits$plot[[10]] + theme(legend.position = "none")) +
   interaction_fits$plot[[11]] +
  (interaction_fits$plot[[12]] + theme(legend.position = "none"))

(duration_plot/efficiency_plot/jetlag_plot/subjective_plot) 
  # plot_annotation(title = "Interaction between CTQ abuse subscales and sleep predictors",
                  # theme = theme(plot.title = element_text(hjust = 0.8)))
```

